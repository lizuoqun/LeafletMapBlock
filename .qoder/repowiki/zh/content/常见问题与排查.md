# 常见问题与排查

<cite>
**本文档引用文件**  
- [README.md](file://README.md)
- [doc/README-ENG.md](file://doc/README-ENG.md)
- [src/lib/LeafletManyPoint.ts](file://src/lib/LeafletManyPoint.ts)
- [src/lib/leaflet-markers-canvas.js](file://src/lib/leaflet-markers-canvas.js)
- [src/lib/LeafletMapBlock.ts](file://src/lib/LeafletMapBlock.ts)
- [src/lib/ReadMe.md](file://src/lib/ReadMe.md)
</cite>

## 目录
1. [简介](#简介)
2. [图标未显示](#图标未显示)
3. [点击事件不触发](#点击事件不触发)
4. [Canvas模糊](#canvas模糊)
5. [内存泄漏](#内存泄漏)
6. [LeafletManyPoint.ts 与 leaflet-markers-canvas.js 共存问题](#leafletmanypointts-与-leaflet-markers-canvasjs-共存问题)
7. [地图块异常排查](#地图块异常排查)

## 简介
本文档旨在为开发者提供一份详尽的常见问题解答与故障排查指南，涵盖在使用 `LeafletMapBlock` 模块过程中可能遇到的典型问题。结合项目中的 `README.md` 和 `doc/README-ENG.md` 文件说明，本文将提供具体的诊断步骤和解决方案，帮助开发者快速定位并解决问题。

**Section sources**
- [README.md](file://README.md#L1-L71)
- [doc/README-ENG.md](file://doc/README-ENG.md#L1-L72)

## 图标未显示
### 问题描述
在使用 `ManyMarkersCanvas` 图层时，自定义图标（icon）未能正常显示。

### 可能原因
1. **iconUrl 路径错误**：提供的图标路径不正确或资源不存在。
2. **跨域问题**：图标资源位于不同域，浏览器因 CORS 策略阻止加载。
3. **SVG 图标处理异常**：对于内联 SVG 图标，Blob URL 创建或加载失败。

### 解决方案
1. **检查路径**：确认 `icon` 字段指向的 URL 或路径正确且可访问。
2. **处理跨域**：确保图标服务器配置了正确的 CORS 头，或使用代理服务器。
3. **调试 SVG**：对于 SVG 图标，检查 `Blob` 创建和 `Image` 加载过程，确保 `onload` 回调正确执行。
4. **使用开发者工具**：在浏览器开发者工具的“网络”(Network) 标签中检查图标资源的请求状态。

**Section sources**
- [src/lib/LeafletManyPoint.ts](file://src/lib/LeafletManyPoint.ts#L130-L180)

## 点击事件不触发
### 问题描述
为图标绑定的 `onIconClick` 回调函数未被调用。

### 可能原因
1. **事件绑定方式错误**：未正确初始化事件监听器。
2. **坐标转换精度问题**：`latLngToContainerPoint` 转换后的坐标与实际点击坐标存在偏差。
3. **图层层级问题**：其他图层覆盖了 `ManyMarkersCanvas` 图层，导致点击事件被拦截。

### 解决方案
1. **确认事件初始化**：确保 `_initIconClickEvent` 方法在 `onAdd` 后被正确调用。
2. **检查坐标逻辑**：验证 `_initIconClickEvent` 中的 `checkIconInteraction` 函数，确保坐标判断逻辑（`isInIcon`）正确。
3. **调试事件流**：在 `click` 和 `mousemove` 事件回调中添加 `console.log`，确认事件是否被触发。
4. **检查图层顺序**：使用 `getPane()` 确认 `ManyMarkersCanvas` 图层的 DOM 顺序。

**Section sources**
- [src/lib/LeafletManyPoint.ts](file://src/lib/LeafletManyPoint.ts#L185-L261)

## Canvas模糊
### 问题描述
在高分辨率屏幕（如 Retina 屏）上，Canvas 绘制的内容显得模糊。

### 可能原因
1. **设备像素比 (DPR) 未适配**：Canvas 的 CSS 像素与设备物理像素不匹配。

### 解决方案
1. **DPR 适配**：在 `_initCanvas` 方法中，根据 `window.devicePixelRatio` 调整 Canvas 的 `width` 和 `height`，并使用 `setTransform` 进行缩放。
   ```typescript
   const ratio = window.devicePixelRatio || 1;
   this._canvas.width = x * ratio;
   this._canvas.height = y * ratio;
   this._context.scale(ratio, ratio);
   ```
2. **更新 `_reset` 方法**：确保在 `_reset` 中也应用 DPR 适配逻辑。

**Section sources**
- [src/lib/LeafletManyPoint.ts](file://src/lib/LeafletManyPoint.ts#L60-L70)
- [src/lib/ReadMe.md](file://src/lib/ReadMe.md#L117-L144)

## 内存泄漏
### 问题描述
长时间使用后，应用内存占用持续增长。

### 可能原因
1. **图层未正确移除**：`onRemove` 方法未被调用或未清理事件监听和资源。
2. **缓存未清理**：`imageCache` 和 `svgImageCache` 持续增长，未及时释放。

### 解决方案
1. **实现 `onRemove` 方法**：参考 `leaflet-markers-canvas.js`，在 `onRemove` 中移除 DOM 元素和事件监听。
   ```typescript
   onRemove(map) {
     this.getPane().removeChild(this._canvas);
     map.off("moveend", this._reset, this);
     map.off("resize", this._reset, this);
     // ... 其他事件
   }
   ```
2. **清理缓存**：在 `onRemove` 或 `clear` 方法中清空 `imageCache`、`svgImageCache` 和 `containerPointsCache`。
3. **使用内存快照**：在浏览器开发者工具中对比操作前后的内存快照，定位泄漏对象。

**Section sources**
- [src/lib/leaflet-markers-canvas.js](file://src/lib/leaflet-markers-canvas.js#L100-L120)
- [src/lib/LeafletManyPoint.ts](file://src/lib/LeafletManyPoint.ts#L50-L55)

## LeafletManyPoint.ts 与 leaflet-markers-canvas.js 共存问题
### 问题描述
项目中同时存在 `LeafletManyPoint.ts` 和 `leaflet-markers-canvas.js`，导致开发者困惑应使用哪个。

### 解答
- **`leaflet-markers-canvas.js` 是遗留实现**：该文件基于 `RBush` 优化了大量标记的渲染，但为旧版 JavaScript 实现。
- **`LeafletManyPoint.ts` 是当前主流程**：此文件为 TypeScript 实现，提供了更灵活的 `MarkerPointOptions` 接口，支持自定义图标点击、悬停事件，并使用了缓存机制优化性能。
- **推荐使用 `LeafletManyPoint.ts`**：新项目应使用 `ManyMarkersCanvas` 类，它更符合现代开发规范，且易于维护和扩展。

**Section sources**
- [src/lib/LeafletManyPoint.ts](file://src/lib/LeafletManyPoint.ts#L1-L262)
- [src/lib/leaflet-markers-canvas.js](file://src/lib/leaflet-markers-canvas.js#L1-L437)
- [src/lib/ReadMe.md](file://src/lib/ReadMe.md#L64-L98)

## 地图块异常排查
### 问题描述
地图上的某个瓦片显示异常。

### 解决方案
1. **理解瓦片机制**：每个地图块都是一个静态的 `img` 图片，其 URL 遵循 `{z}/{x}/{y}.png` 模式。
2. **定位瓦片坐标**：通过插件可在瓦片上看到其 `x`, `y`, `z` 坐标，这些坐标直接对应 URL 中的参数。
3. **检查网络请求**：使用浏览器开发者工具的“网络”标签，查找对应 `x`, `y`, `z` 的请求，检查状态码和响应内容。
4. **验证资源路径**：确认静态资源服务器能正确响应请求的瓦片图片。

**Section sources**
- [README.md](file://README.md#L65-L71)
- [doc/README-ENG.md](file://doc/README-ENG.md#L66-L72)