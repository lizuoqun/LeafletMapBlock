# 构造函数与配置项

<cite>
**本文档引用的文件**
- [LeafletManyPoint.ts](file://src/lib/LeafletManyPoint.ts#L8-L17)
- [LeafletManyPoint.ts](file://src/lib/LeafletManyPoint.ts#L19-L260)
</cite>

## 目录
1. [简介](#简介)
2. [MarkerPointOptions 接口定义](#markerpointoptions-接口定义)
3. [points 参数字段详解](#points-参数字段详解)
4. [事件回调中的 data 字段传递](#事件回调中的-data-字段传递)
5. [可选的 options 参数扩展](#可选的-options-参数扩展)
6. [图层级与 zIndex 支持](#图层级与-zindex-支持)
7. [TypeScript 类型定义示例](#typescript-类型定义示例)

## 简介
`ManyMarkersCanvas` 是一个基于 Leaflet 的自定义 Canvas 图层类，用于高效渲染大量标记点。该类通过 `L.Layer.extend` 扩展实现，并接受一个标记点数组作为初始化参数。本文档详细说明其构造函数中 `points` 参数的结构定义、各字段含义及其在渲染和交互中的作用，同时解释可选配置项和 TypeScript 使用方式。

**Section sources**
- [LeafletManyPoint.ts](file://src/lib/LeafletManyPoint.ts#L19-L260)

## MarkerPointOptions 接口定义
`ManyMarkersCanvas` 构造函数接收一个 `MarkerPointOptions` 类型的数组作为参数。该接口定义了每个标记点所需的基本属性和可选行为。

```typescript
interface MarkerPointOptions {
  lat: number;
  lng: number;
  title: string;
  icon: string;
  iconSize: number[];
  onIconClick?: (item: MarkerPointOptions) => void;
  onIconMouseOver?: (item: MarkerPointOptions) => void;
  onIconMouseOut?: (item: MarkerPointOptions) => void;
}
```

此接口位于 `LeafletManyPoint.ts` 文件中，是所有标记点数据的类型契约。

**Section sources**
- [LeafletManyPoint.ts](file://src/lib/LeafletManyPoint.ts#L8-L17)

## points 参数字段详解
以下是 `MarkerPointOptions` 接口中各个字段的详细说明：

### lat（纬度）
- **类型**: `number`
- **描述**: 标记点的地理纬度坐标，使用 WGS84 坐标系。
- **作用**: 与 `lng` 一起确定标记在地图上的位置，用于坐标转换和可视区域判断。

### lng（经度）
- **类型**: `number`
- **描述**: 标记点的地理经度坐标，使用 WGS84 坐标系。
- **作用**: 同上，与 `lat` 共同构成地理坐标。

### iconUrl（图标路径或 SVG 字符串）
- **实际字段名**: `icon`
- **类型**: `string`
- **描述**: 图标的 URL 路径或内联 SVG 字符串（以 `<svg` 开头）。
- **作用**: 在 `_drawIcon` 方法中被解析，若为 SVG 则创建 Blob URL 加载，否则直接作为图片源加载并绘制到 Canvas 上。支持缓存机制以提升性能。

### iconSize（图标尺寸）
- **实际字段名**: `iconSize`
- **类型**: `number[]`（长度为 2 的数组，格式为 `[width, height]`）
- **描述**: 图标的宽度和高度（像素）。
- **作用**: 决定图标在 Canvas 上的绘制尺寸，并用于计算点击检测区域和文本偏移位置。

### title（标注文本）
- **实际字段名**: `title`
- **类型**: `string`
- **描述**: 显示在图标下方的文本标签。
- **作用**: 在 `_drawText` 方法中使用，自动根据当前视图边界只渲染可见区域内的文本，提升渲染效率。

### data（附加数据对象）
- **注意**: 当前接口中未显式包含 `data` 字段，但可通过扩展 `MarkerPointOptions` 接口添加。
- **建议类型**: `any` 或自定义对象类型
- **描述**: 用户可附加任意结构的数据，用于事件回调中携带上下文信息。
- **作用**: 在点击或悬停事件触发时，可通过回调函数参数完整回传该对象，便于业务逻辑处理。

**Section sources**
- [LeafletManyPoint.ts](file://src/lib/LeafletManyPoint.ts#L8-L17)

## 事件回调中的 data 字段传递
虽然原始接口未定义 `data` 字段，但用户可在使用时自行扩展 `MarkerPointOptions` 类型以包含 `data` 属性。例如：

```ts
interface ExtendedMarkerPointOptions extends MarkerPointOptions {
  data: { id: string; category: string };
}
```

当用户定义 `onIconClick` 或 `onIconMouseOver` 回调时，传入的 `item` 参数即为完整的标记对象，包括扩展的 `data` 字段。系统在检测到鼠标交互后，会直接调用这些回调并将整个 `item` 对象作为参数传递，确保附加数据能够完整回传。

**Section sources**
- [LeafletManyPoint.ts](file://src/lib/LeafletManyPoint.ts#L220-L255)

## 可选的 options 参数扩展
当前 `ManyMarkersCanvas` 的 `initialize` 方法仅接受 `Points: MarkerPointOptions[]` 作为参数，并未实现标准的 `options` 配置对象。然而，Leaflet 的 `L.Util.setOptions(this, Points)` 调用暗示了未来可支持选项合并机制。

建议未来扩展如下可选配置项：
- `zIndex`: 控制 Canvas 图层的堆叠顺序
- `opacity`: 设置图层整体透明度
- `iconAnchor`: 自定义图标锚点
- `textOffset`: 自定义文本垂直偏移量

这些配置可在 `initialize` 方法中通过第二个参数传入，并结合默认值进行合并。

**Section sources**
- [LeafletManyPoint.ts](file://src/lib/LeafletManyPoint.ts#L22-L24)

## 图层级与 zIndex 支持
目前图层的 `zIndex` 是通过 CSS 类名中的内联样式固定设置的。在 `LeafletMapBlock.ts` 文件中，`createTile` 方法设置了 `tile.style.zIndex = '90';`，表明图块图层的堆叠层级为 90。

对于 `ManyMarkersCanvas`，其 DOM 元素是通过 `getPane().appendChild(this._canvas)` 添加到默认图层面板的，未显式设置 `zIndex`。因此其层级由 Leaflet 的默认面板顺序决定。若需调整，建议在 `_initCanvas` 后手动设置 `this._canvas.style.zIndex`。

**Section sources**
- [LeafletMapBlock.ts](file://src/lib/LeafletMapBlock.ts#L38)
- [LeafletManyPoint.ts](file://src/lib/LeafletManyPoint.ts#L60)

## TypeScript 类型定义示例
为帮助 TypeScript 用户正确使用 `ManyMarkersCanvas`，以下提供完整的类型定义示例：

```typescript
interface MarkerPointOptions {
  lat: number;
  lng: number;
  title: string;
  icon: string;
  iconSize: number[];
  data?: Record<string, any>;
  onIconClick?: (item: MarkerPointOptions) => void;
  onIconMouseOver?: (item: MarkerPointOptions) => void;
  onIconMouseOut?: (item: MarkerPointOptions) => void;
}

// 使用示例
const points: MarkerPointOptions[] = [
  {
    lat: 39.909722,
    lng: 116.397026,
    title: '北京',
    icon: '<svg>...</svg>',
    iconSize: [32, 32],
    data: { id: 'P001', type: 'capital' },
    onIconClick: (item) => console.log('Clicked:', item.data),
    onIconMouseOver: (item) => console.log('Hovered:', item.title)
  }
];

const markersLayer = new (L.Layer.extend({}) as any)(points);
map.addLayer(markersLayer);
```

此示例展示了如何定义包含 `data` 字段的扩展接口，并正确传递事件回调函数。

**Section sources**
- [LeafletManyPoint.ts](file://src/lib/LeafletManyPoint.ts#L8-L17)