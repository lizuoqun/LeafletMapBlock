# 安装与集成

<cite>
**本文档中引用的文件**  
- [package.json](file://package.json)
- [src/lib/LeafletMapBlock.ts](file://src/lib/LeafletMapBlock.ts)
- [src/lib/LeafletManyPoint.ts](file://src/lib/LeafletManyPoint.ts)
- [src/lib/ReadMe.md](file://src/lib/ReadMe.md)
- [README.md](file://README.md)
</cite>

## 目录
1. [安装方法](#安装方法)
2. [模块导入与使用](#模块导入与使用)
3. [构建环境兼容性](#构建环境兼容性)
4. [核心依赖与版本要求](#核心依赖与版本要求)
5. [Vue 3 中的集成示例](#vue-3-中的集成示例)
6. [原生 JavaScript 中的使用示例](#原生-javascript-中的使用示例)
7. [库的模块化结构解析](#库的模块化结构解析)
8. [关于未使用依赖的说明](#关于未使用依赖的说明)

## 安装方法

要将 `LeafletMapBlock` 集成到您的项目中，首先通过 NPM 安装该库：

```bash
npm install leaflet-map-block
```

或者使用 Yarn：

```bash
yarn add leaflet-map-block
```

安装完成后，库文件将被添加到 `node_modules` 目录中，您可以在项目中通过 ES 模块语法进行导入。

**Section sources**
- [README.md](file://README.md#L15-L25)

## 模块导入与使用

在 ES 模块环境中，您可以使用标准的 `import` 语法从 `leaflet-map-block` 导入所需的组件。例如，导入 `ManyMarkersCanvas` 类：

```typescript
import { ManyMarkersCanvas } from 'leaflet-map-block';
```

此外，您还可以导入 `LeafletMapBlockLayer` 用于渲染地图瓦片网格：

```typescript
import { LeafletMapBlockLayer } from 'leaflet-map-block';
```

导入后即可在地图实例中使用这些类来添加自定义图层。

**Section sources**
- [README.md](file://README.md#L55-L60)

## 构建环境兼容性

该库使用 Vite 构建，支持现代 ES 模块环境。在以下构建工具中均可正常使用：

- **Vite**：原生支持 `.ts` 和 `.vue` 文件，无需额外配置。
- **Webpack**：需确保配置了 TypeScript 和 Vue 的加载器（如 `ts-loader` 和 `vue-loader`）。
- **其他基于 ES 模块的构建系统**：只要支持现代 JavaScript 和 TypeScript，均可直接使用。

建议在 `tsconfig.json` 中启用 `esModuleInterop` 和 `allowSyntheticDefaultImports` 以确保类型兼容性。

**Section sources**
- [vite.config.ts](file://vite.config.ts)
- [tsconfig.json](file://tsconfig.json)

## 核心依赖与版本要求

根据 `package.json` 文件，本库的核心运行时依赖包括：

- **Leaflet**：`^1.9.4` —— 地图核心库，提供地图渲染与交互功能。
- **Vue**：`^3.5.17` —— 用于 Vue 3 组件的开发与集成。
- **coordtransform**：`^2.1.2` —— 坐标转换工具（见下文说明）。
- **rbush**：`^4.0.1` —— 空间索引库，用于高效处理大量图层元素。

开发依赖包括 `typescript`、`vite` 和 `@types/leaflet`，用于构建和类型检查。

**Section sources**
- [package.json](file://package.json#L15-L25)

## Vue 3 中的集成示例

在 Vue 3 项目中，您可以在组件的 `setup` 或 `onMounted` 钩子中初始化地图并添加自定义图层。示例如下：

```typescript
import { ref, onMounted } from 'vue';
import L from 'leaflet';
import { ManyMarkersCanvas } from 'leaflet-map-block';

export default {
  setup() {
    const mapContainer = ref(null);

    onMounted(() => {
      const map = L.map(mapContainer.value).setView([39.9042, 116.4074], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

      const points = [
        {
          lat: 39.9042,
          lng: 116.4074,
          title: '北京',
          icon: 'https://example.com/icon.png',
          iconSize: [32, 32],
          onIconClick: (item) => alert(`点击了：${item.title}`),
        },
      ];

      const markerLayer = new ManyMarkersCanvas(points);
      markerLayer.addTo(map);
    });

    return { mapContainer };
  },
};
```

**Section sources**
- [src/lib/LeafletManyPoint.ts](file://src/lib/LeafletManyPoint.ts#L1-L262)
- [src/lib/ReadMe.md](file://src/lib/ReadMe.md#L100-L150)

## 原生 JavaScript 中的使用示例

在纯 JavaScript 环境中，您可以在页面加载完成后初始化地图并添加图层：

```javascript
import L from 'leaflet';
import { LeafletMapBlockLayer } from 'leaflet-map-block';

document.addEventListener('DOMContentLoaded', () => {
  const map = L.map('map').setView([39.9042, 116.4074], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  // 添加地图分块图层
  const blockLayer = new LeafletMapBlockLayer({
    lineDash: [2, 2],
    showGridText: true,
  });
  map.addLayer(blockLayer);
});
```

此示例展示了如何使用 `LeafletMapBlockLayer` 在地图瓦片上绘制带文字的网格。

**Section sources**
- [src/lib/LeafletMapBlock.ts](file://src/lib/LeafletMapBlock.ts#L1-L79)
- [README.md](file://README.md#L55-L60)

## 库的模块化结构解析

`package.json` 文件中定义了库的模块入口：

- `"main": "dist/LeafletMapBlock.js"`：CommonJS 模块入口。
- `"module": "dist/LeafletMapBlock.js"`：ES 模块入口，适用于现代构建工具。
- `"types": "dist/LeafletMapBlock.d.ts"`：TypeScript 类型定义文件，提供完整的类型支持。

这意味着无论使用哪种模块系统，都能正确加载库。类型文件确保了在 TypeScript 项目中获得智能提示和编译时检查。

**Section sources**
- [package.json](file://package.json#L3-L7)

## 关于未使用依赖的说明

尽管 `package.json` 中声明了 `rbush` 和 `coordtransform` 作为依赖，但在当前源码分析中，`rbush` 仅在 `src/lib/leaflet-markers-canvas.js` 中被导入，而 `coordtransform` 并未在任何 TypeScript 文件中被引用。

这表明：
- `rbush` 可能用于空间索引优化，但在主模块 `LeafletManyPoint.ts` 中并未实际使用。
- `coordtransform` 可能为未来功能预留，当前版本中未启用。

建议开发者注意这些依赖可能带来的包体积增加，若确定无需坐标转换或空间索引，可考虑在构建时排除。

**Section sources**
- [package.json](file://package.json#L20-L21)
- [src/lib/leaflet-markers-canvas.js](file://src/lib/leaflet-markers-canvas.js#L1)
- [src/lib/LeafletManyPoint.ts](file://src/lib/LeafletManyPoint.ts#L1)